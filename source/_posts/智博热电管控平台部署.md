---
title: 智博热电管控平台部署
date: 2024-04-07
categories:
  - 工作
  - 部署
tags:
  - 管控平台
---

# 数据库

数据库版本： MySQL-5.7.26

数据库相关配置

mysql.ini

```ini
[mysql]
default-character-set=utf8

[mysqld]
port=3306
basedir=D:/phpstudy_pro/Extensions/MySQL5.7.26/
datadir=D:/phpstudy_pro/Extensions/MySQL5.7.26/data/
character-set-server=utf8
default-storage-engine=MyIsam
max_connections=100
collation-server=utf8_unicode_ci
init_connect='SET NAMES utf8'
innodb_buffer_pool_size=64M
innodb_flush_log_at_trx_commit=1
innodb_lock_wait_timeout=120
innodb_log_buffer_size=4M
innodb_log_file_size=256M
interactive_timeout=120
join_buffer_size=2M
key_buffer_size=32M
log_error_verbosity=1
max_allowed_packet=16M
max_heap_table_size=64M
myisam_max_sort_file_size=64G
myisam_sort_buffer_size=32M
read_buffer_size=512kb
read_rnd_buffer_size=4M
server_id=1
skip-external-locking=on
sort_buffer_size=256kb
table_open_cache=256
thread_cache_size=16
tmp_table_size=64M
wait_timeout=120
sql_mode= NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION  #模式配置，不然会报错

[client]
port=3306
default-character-set=utf8

```

配置完成后，直接导入即可

# PHP版本

下载phpstudy_pro安装，php版本5.6.9nts ,配置网站根目录：cp-zhiboredian-net/web

# 伪静态配置

```
location / {
    if (!-e $request_filename) {
        rewrite /app/(.*)$ /app.php/$1 last;
        rewrite /app_dev/(.*)$ /app_dev.php/$1 last;
        rewrite  ^(.*)$  /app.php?s=$1  last;
        break;
    }
}
```

# 代码

## 数据库配置文件

**cp-zhiboredian-net/app/config/parameters.yml**

```yml
database_host: 127.0.0.1
database_user: root
database_password: 123456
```

## 登录密码判断

**cp-zhiboredian-net/src/AppBundle/Handler/AuthenticationProvider.php**

```php
//58行附近

if (!$this->encoderFactory->getEncoder($user)->isPasswordValid($user->getPassword(), $presentedPassword, $user->getSalt())) {
    throw new BadCredentialsException('The presented password is invalid.');
}
```

## 密码重置逻辑

```php
//use Symfony\Component\Security\Core\Encoder\MessageDigestPasswordEncoder;
//MessageDigestPasswordEncoder类用来生成密码
$encoder = new MessageDigestPasswordEncoder('sha256');
$raw = "123456";
$salt = "ny22a724jbkcwggo4s0ccckcwsc8gwg";
$encodePassword = $encoder->encodePassword($raw, $salt);
echo $encodePassword."<br>";

//解析类MessageDigestPasswordEncoder的功能
$salted = $raw.'{'.$salt.'}';
$digest = hash("sha256", $salted, true);

// "stretch" hash
for ($i = 1; $i < 5000; ++$i) {
    $digest = hash("sha256", $digest.$salted, true);
}

echo $salt."<br>";
echo base64_encode($digest);
```

## 项目首页Controller

```php
src/CustomBundle/Controller/System/TyjhIndexController.php
```

## 路由加载机制

EduSoho 是基于 Symfony 框架的开源在线教育平台，因此它的配置文件加载顺序在很大程度上继承了 Symfony 框架的机制。不过，EduSoho 本身也有其特定的加载机制和配置文件结构。以下是 EduSoho 中配置文件的加载顺序及机制的概述：

### 1. **核心框架配置加载**

- **`app/config/config.yml`**
  - 这是 EduSoho 的主配置文件，通常是 Symfony 的 `app/config/config.yml` 文件。它包含了应用程序的全局配置，如数据库连接、服务、参数等。
  - 此文件会首先加载，并作为所有其他配置的基础。
- **`app/config/parameters.yml`**
  - 包含应用程序中用到的全局参数，如数据库连接的凭据、邮件服务的配置等。`parameters.yml` 文件通常通过安装时的参数定义生成。
  - 这个文件也在早期阶段加载，以便在其他配置文件中使用参数。

### 2. **插件与模块的配置加载**

- **`src/` 目录中的模块**
  - EduSoho 中的插件和模块通常位于 `src/` 目录下。每个插件或模块可能都有自己的配置文件，通常位于模块目录下的 `Resources/config/` 中。
  - 这些配置文件会在 `app/config/config.yml` 加载之后，根据模块的定义顺序依次加载。
- **`src/` 目录中的插件的路由配置**
  - 各插件的路由配置文件通常位于 `src/PluginName/Resources/config/routing.yml` 或 `routing.php` 中。它们的加载顺序依据插件的初始化顺序决定，通常在核心应用的路由加载之后。

### 3. **环境特定的配置加载**

- `app/config/config_{environment}.yml`
  - 与 Symfony 类似，EduSoho 也支持环境特定的配置。例如，`config_dev.yml` 用于开发环境，`config_prod.yml` 用于生产环境。
  - 这些文件会在全局配置加载后加载，并覆盖全局配置中的相关设置。

### 4. **服务配置**

- `services.yml` 与 `services_{environment}.yml`
  - 类似于 Symfony，EduSoho 中的服务配置文件也会在配置加载的较晚阶段被加载。这些文件用于定义和配置服务容器中的服务，通常位于 `app/config/services.yml` 中。
  - 环境特定的服务配置文件（如 `services_dev.yml`）会覆盖默认的服务配置。

### 5. **路由配置**

- `app/config/routing.yml`
  - EduSoho 使用 Symfony 的路由配置机制。`routing.yml` 文件通常是核心应用路由的入口点。所有插件和模块的路由会被合并到主路由配置中。
  - 路由配置文件通常在所有服务和配置加载之后加载，以确保路由可以依赖其他已加载的服务。

### 6. **插件的优先级与加载顺序**

- 插件的加载顺序通常由 `AppKernel.php` 文件中的 `registerBundles()` 方法定义。如果需要控制插件的加载顺序，可以在这里调整。
- 插件中的配置会覆盖之前加载的核心配置，确保插件能够根据需要自定义和扩展平台功能。

### 总结

- **全局配置文件** (`config.yml`, `parameters.yml`) 最早加载，提供应用程序的基础配置。
- **插件与模块配置** 依次加载，允许自定义和扩展平台功能。
- **环境特定配置** 在全局配置之后加载，并根据运行环境进行配置覆盖。
- **服务和路由配置** 在所有其他配置加载完成后加载，确保可以依赖所有已加载的服务和配置。

### 例子

```yml
crm_contract:
    path:     /crm/contract
    defaults: { _controller: CustomBundle:Crm/Contract:list }
```

这个路由配置段落定义了一个名为 `crm_contract` 的路由，它包含了路径、默认控制器及方法的设定。下面是对每个配置项的详细解释：

1. **路由名称：`crm_contract`**

- **定义**: `crm_contract` 是该路由的唯一标识符。在应用程序的其他地方可以通过这个名称来引用该路由，例如在生成 URL 时。
- **作用**: 路由名称在配置文件中是唯一的，用来区分不同的路由。

2. **`path: /crm/contract`**

- **定义**: `path` 指定了这个路由的 URL 路径为 `/crm/contract`。
- **作用**: 当用户在浏览器中访问 `http://yourdomain.com/crm/contract` 时，该路径会触发对应的控制器操作。这个路径是用户访问应用程序时看到的 URL 部分。

3. **`defaults: { _controller: CustomBundle:Crm/Contract:list }`**

- **定义**: `defaults` 配置中定义了该路由的默认控制器及方法。在这里，`_controller` 是 Symfony 的特殊参数，用来指定处理该路由的控制器和方法。
- 具体解释:
  - `CustomBundle`: 指定了该控制器所在的 bundle，通常是应用程序中的一个模块或功能包。
  - `Crm/Contract`: 指定了控制器的名称。在 Symfony 中，控制器通常以 `Controller` 作为后缀，实际上这里指定的是 `Crm/ContractController`。
  - `list`: 指定了控制器中的一个方法，通常以 `Action` 作为后缀。这个方法处理用户对 `/crm/contract` 路径的请求。在这个例子中，实际上调用的可能是 `listAction` 方法。
- **作用**: 当用户访问 `/crm/contract` 路径时，Symfony 会调用 `CustomBundle` 中的 `Crm/ContractController` 控制器的 `listAction` 方法来处理该请求。

综合理解

当用户访问 `/crm/contract` 路径时，Symfony 会查找到名为 `crm_contract` 的路由，并将请求映射到 `CustomBundle` 的 `Crm/ContractController` 控制器的 `listAction` 方法。这意味着该路径对应的业务逻辑将在这个控制器方法中处理，通常会返回一个视图或执行某种逻辑操作。

例如，这个路由可能用于显示 CRM 合同列表的页面。当访问 `http://yourdomain.com/crm/contract` 时，`listAction` 方法会被调用，可能会从数据库中检索合同数据并将其显示在网页上。



## 数据库

### $this->db() 的使用场景

`$this->db()` 是一个用于访问数据库连接的快捷方法，通常在 DAO（数据访问对象）层使用。它返回一个数据库连接实例，允许你直接执行 SQL 查询，而不必通过 Doctrine ORM。这个方法是 EduSoho 框架特有的，方便开发者在需要时直接操作数据库。

### 常用方法

以下是 `$this->db()` 返回的连接对象的一些常用方法：

- **`fetchAll($sql, $params)`**: 执行查询并返回所有结果。
- **`fetchAssoc($sql, $params)`**: 执行查询并返回一个关联数组，其中键为第一列的值，值为整行数据。
- **`fetchColumn($sql, $params)`**: 执行查询并返回单个列的值。
- **`executeUpdate($sql, $params)`**: 执行更新查询（如 `INSERT`, `UPDATE`, `DELETE`），返回受影响的行数。
- **`beginTransaction()`**: 开始一个数据库事务。
- **`commit()`**: 提交当前事务。
- **`rollBack()`**: 回滚当前事务。

# 补充

默认用户初始密码：123456